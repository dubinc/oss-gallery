"use client";
import typesense, { ProjectHit } from "@/lib/typesense";
import Link from "next/link";
import { useEffect, useState } from "react";
import { useDebounce } from "use-debounce";

export default function SearchAutocomplete({ query }: { query: string }) {
  const [debouncedQuery] = useDebounce(query, 300);
  const [data, setData] = useState<ProjectHit[]>([]);

  useEffect(() => {
    const abortController = new AbortController();

    if (!debouncedQuery) return setData([]);
    const fetchAutocomplete = async (q: string) => {
      try {
        const results = await typesense
          .collections("projects")
          .documents()
          .search(
            {
              q,
              query_by: "name",
              highlight_full_fields: "name",
              num_typos: 1,
              limit: 8,
              exclude_fields: ["out_of", "search_time_ms"],
            },
            {
              abortSignal: abortController.signal,
            },
          );
        setData(results.hits as ProjectHit[]);
      } catch (error) {
        if (error.name === "AbortError") {
        }
        // error handling
      }
    };
    fetchAutocomplete(debouncedQuery);

    return () => {
      abortController.abort();
    };
  }, [debouncedQuery]);

  return (
    <div className="absolute mt-2 w-full overflow-hidden rounded-md border-gray-200 bg-white shadow-lg">
      <ul className="text-sm">
        {data.map(({ document }) => (
          <li className="w-full" key={document.id}>
            <Link
              className="flex w-full justify-between border-b border-gray-200 px-4 py-3 hover:bg-slate-200"
              href={`/projects/${document.slug}`}
            >
              <span>{document.name}</span>
            </Link>
          </li>
        ))}
      </ul>
      {data.length > 0 && (
        <div className="flex items-center justify-end gap-1 px-4 py-3 text-xs text-gray-500">
          Powered by
          <a
            href="https://typesense.org/"
            target="_blank"
            rel="noopener noreferrer"
          >
            <TypesenseLogo />
          </a>
        </div>
      )}
    </div>
  );
}

function TypesenseLogo() {
  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="67.5px"
      height="15px"
      viewBox="0 0 512 114"
    >
      <path
        fill="#ed0e73"
        d="M31.032 32.624a16.79 16.79 0 0 1 .342 3.297c0 .985-.114 2.045-.342 3.182l-14.436-.113v38.193c0 3.183 1.478 4.775 4.433 4.775h8.64c.53 1.288.795 2.576.795 3.864c0 1.289-.076 2.085-.227 2.388a83.425 83.425 0 0 1-10.799.682c-7.35 0-11.026-3.145-11.026-9.435V38.99l-8.071.113A16.285 16.285 0 0 1 0 35.921c0-1.062.114-2.16.341-3.297l8.07.114V20.802c0-2.046.304-3.486.91-4.32c.606-.909 1.781-1.364 3.524-1.364h3.07l.681.682v17.051zm55.005.568L70.464 86.505c-2.88 9.775-5.949 16.672-9.207 20.688c-3.259 4.016-8.147 6.025-14.664 6.025c-3.334 0-6.403-.493-9.207-1.478c-.228-2.122.379-4.168 1.818-6.138c2.35.833 4.85 1.25 7.503 1.25c4.016 0 7.085-1.364 9.207-4.092c2.122-2.728 4.055-6.972 5.798-12.732l.34-1.136c-1.97-.152-3.485-.607-4.546-1.364c-.985-.758-1.819-2.16-2.501-4.206L39.09 33.306c2.349-.985 4.016-1.478 5.001-1.478c2.198 0 3.676 1.326 4.434 3.979l9.271 29.468c.666 2.195 2.312 7.793 4.938 16.796c.151.53.53.796 1.136.796l13.87-50.243c.986-.303 2.274-.455 3.865-.455c1.668 0 3.07.228 4.206.682zm21.842 51.494v22.507c0 2.046-.303 3.486-.909 4.32c-.606.909-1.819 1.363-3.638 1.363h-3.069l-.682-.682V32.965l.682-.682h2.956c1.679 0 2.84.42 3.487 1.26l.15.218c.682.909 1.023 2.425 1.023 4.547v.568c4.547-5.077 9.966-7.616 16.255-7.616c6.442 0 11.292 2.614 14.55 7.843c3.26 5.153 4.889 12.315 4.889 21.484c0 4.471-.607 8.488-1.82 12.05c-1.136 3.561-2.69 6.593-4.66 9.093c-1.894 2.425-4.092 4.32-6.593 5.684c-2.5 1.288-5.077 1.932-7.73 1.932c-4.938 0-9.64-1.385-14.105-4.157zm0-36.944v29.214c4.623 3.41 8.98 5.115 13.073 5.115c4.092 0 7.464-1.818 10.116-5.456c2.653-3.637 3.98-9.132 3.98-16.482c0-3.307-.283-6.207-.846-8.7l-.178-.735c-.606-2.728-1.44-4.964-2.5-6.707c-.956-1.637-2.064-2.875-3.326-3.713l-.426-.265c-1.364-.91-2.842-1.364-4.433-1.364c-3.032 0-5.911.795-8.64 2.387c-2.517 1.469-4.648 3.486-6.392 6.053zm93.253 15.346h-35.238c.379 12.883 5.267 19.324 14.664 19.324c5.153 0 10.647-1.591 16.482-4.774c1.667 1.516 2.69 3.448 3.07 5.797c-6.215 4.244-13.187 6.366-20.916 6.366c-3.941 0-7.313-.72-10.117-2.16a20.025 20.025 0 0 1-6.934-6.138c-1.743-2.652-3.032-5.76-3.865-9.321c-.834-3.562-1.25-7.465-1.25-11.708c0-4.32.492-8.26 1.477-11.822c1.061-3.562 2.577-6.631 4.547-9.208c1.97-2.576 4.32-4.585 7.048-6.024c2.804-1.44 5.986-2.16 9.548-2.16c3.196 0 6.073.541 8.631 1.624l.69.308c2.57 1.112 4.727 2.637 6.47 4.576l.464.54c1.895 2.121 3.335 4.698 4.32 7.73c.985 2.955 1.478 6.138 1.478 9.548c0 1.364-.076 2.69-.228 3.978c-.05.809-.118 1.6-.202 2.375zm-35.238-6.48h27.281v-1.477c0-5.229-1.099-9.435-3.296-12.618c-2.198-3.182-5.494-4.774-9.89-4.774c-4.32 0-7.692 1.705-10.117 5.116c-2.218 3.22-3.524 7.489-3.918 12.805zm46.94 27.85c.074-1.667.529-3.485 1.362-5.456c.91-2.046 1.934-3.637 3.07-4.774c5.987 3.258 11.253 4.888 15.8 4.888c2.5 0 4.51-.493 6.025-1.478c1.591-.985 2.388-2.311 2.388-3.978c0-2.653-2.047-4.775-6.14-6.366l-6.365-2.387c-9.548-3.486-14.323-9.056-14.323-16.71c0-2.728.492-5.153 1.479-7.275c1.06-2.198 2.499-4.054 4.319-5.57c1.894-1.591 4.13-2.804 6.707-3.637c2.576-.834 5.456-1.25 8.639-1.25c1.439 0 3.03.113 4.774.34c1.818.227 3.638.569 5.455 1.023c1.82.38 3.562.834 5.23 1.364c1.667.53 3.106 1.099 4.319 1.705c0 1.895-.379 3.865-1.137 5.911c-.757 2.047-1.78 3.562-3.07 4.547c-5.986-2.652-11.176-3.978-15.571-3.978c-1.97 0-3.525.492-4.661 1.478c-1.137.909-1.705 2.121-1.705 3.637c0 2.35 1.894 4.206 5.684 5.57l6.934 2.5c5 1.744 8.715 4.13 11.14 7.162c2.425 3.031 3.638 6.555 3.638 10.572c0 5.38-2.01 9.7-6.026 12.958c-4.017 3.183-9.775 4.774-17.277 4.774c-7.352 0-14.249-1.856-20.688-5.57m99.624-19.438h-31.373c.228 4.169 1.175 7.465 2.84 9.89c1.744 2.35 4.738 3.524 8.98 3.524c4.396 0 9.436-1.288 15.12-3.865c2.197 2.273 3.599 5.267 4.206 8.98c-6.063 4.32-13.338 6.48-21.824 6.48c-8.034 0-14.134-2.464-18.303-7.39c-4.092-5-6.137-12.39-6.137-22.165c0-4.547.53-8.64 1.592-12.277c1.06-3.713 2.612-6.858 4.659-9.435c2.046-2.652 4.547-4.698 7.502-6.138c2.956-1.44 6.328-2.16 10.118-2.16c3.865 0 7.274.606 10.23 1.819c2.956 1.137 5.456 2.804 7.502 5.001c2.047 2.122 3.562 4.661 4.548 7.616c1.06 2.956 1.591 6.177 1.591 9.663c0 1.894-.115 3.713-.341 5.456a56.77 56.77 0 0 1-.64 3.751zM290.52 41.15c-5.91 0-9.094 4.47-9.549 13.413h18.869v-1.364c0-3.638-.758-6.556-2.273-8.753c-1.426-2.068-3.591-3.164-6.494-3.285zm84.237 9.32v24.78c0 4.851.794 8.45 2.386 10.8c-2.425 2.122-5.343 3.183-8.752 3.183c-3.259 0-5.495-.72-6.707-2.16c-1.213-1.516-1.82-3.865-1.82-7.048V53.54c0-3.41-.416-5.798-1.25-7.162c-.833-1.364-2.386-2.046-4.66-2.046c-4.017 0-7.768 1.819-11.254 5.457v38.648a26.483 26.483 0 0 1-3.637.455a60.16 60.16 0 0 1-3.751.113c-1.29 0-2.576-.038-3.865-.113a26.333 26.333 0 0 1-3.524-.455V32.17l.681-.795h5.684c4.245 0 6.897 2.273 7.957 6.82c5.532-4.774 11.027-7.162 16.483-7.162c5.457 0 9.474 1.781 12.05 5.343c2.525 3.32 3.85 7.74 3.97 13.26zm11.924 33.988c.074-1.667.53-3.485 1.363-5.456c.91-2.046 1.933-3.637 3.07-4.774c5.986 3.258 11.252 4.888 15.8 4.888c2.5 0 4.509-.493 6.024-1.478c1.591-.985 2.388-2.311 2.388-3.978c0-2.653-2.046-4.775-6.139-6.366l-6.366-2.387c-9.548-3.486-14.322-9.056-14.322-16.71c0-2.728.492-5.153 1.478-7.275c1.06-2.198 2.5-4.054 4.32-5.57c1.893-1.591 4.129-2.804 6.707-3.637c2.575-.834 5.455-1.25 8.638-1.25c1.44 0 3.03.113 4.774.34c1.818.227 3.638.569 5.456 1.023c1.82.38 3.561.834 5.229 1.364c1.668.53 3.107 1.099 4.32 1.705c0 1.895-.38 3.865-1.137 5.911c-.758 2.047-1.781 3.562-3.07 4.547c-5.987-2.652-11.177-3.978-15.572-3.978c-1.97 0-3.525.492-4.661 1.478c-1.136.909-1.705 2.121-1.705 3.637c0 2.35 1.894 4.206 5.685 5.57l6.933 2.5c5.001 1.744 8.715 4.13 11.14 7.162c2.425 3.031 3.638 6.555 3.638 10.572c0 5.38-2.01 9.7-6.026 12.958c-4.017 3.183-9.775 4.774-17.277 4.774c-7.352 0-14.248-1.856-20.688-5.57m99.624-19.438h-31.373c.229 4.169 1.176 7.465 2.841 9.89c1.744 2.35 4.737 3.524 8.98 3.524c4.396 0 9.435-1.288 15.12-3.865c2.196 2.273 3.598 5.267 4.206 8.98c-6.063 4.32-13.339 6.48-21.825 6.48c-8.033 0-14.133-2.464-18.302-7.39c-4.093-5-6.137-12.39-6.137-22.165c0-4.547.529-8.64 1.591-12.277c1.06-3.713 2.613-6.858 4.66-9.435c2.045-2.652 4.547-4.698 7.503-6.138c2.954-1.44 6.327-2.16 10.117-2.16c3.864 0 7.273.606 10.23 1.819c2.956 1.137 5.455 2.804 7.502 5.001c2.046 2.122 3.561 4.661 4.547 7.616c1.06 2.956 1.592 6.177 1.592 9.663c0 1.894-.114 3.713-.342 5.456a56.77 56.77 0 0 1-.64 3.751zm-21.938-23.87c-5.91 0-9.093 4.47-9.548 13.413h18.87v-1.364c0-3.638-.76-6.556-2.275-8.753c-1.515-2.198-3.864-3.297-7.047-3.297m39.563 63.202V.341C505.066.114 506.355 0 507.796 0c1.515 0 2.917.114 4.204.341v104.01c-1.287.227-2.689.341-4.204.341c-1.441 0-2.73-.114-3.866-.34"
      ></path>
    </svg>
  );
}
